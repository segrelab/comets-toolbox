<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of writeCometsLayout</title>
  <meta name="keywords" content="writeCometsLayout">
  <meta name="description" content="WRITECOMETSLAYOUT(input,[filedir],[filename],[includeParams],[writeModels],[modelFileDir]) Create a layout file along with the corresponding model">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- # CometsToolbox --><!-- menu.html io -->
<h1>writeCometsLayout
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>WRITECOMETSLAYOUT(input,[filedir],[filename],[includeParams],[writeModels],[modelFileDir]) Create a layout file along with the corresponding model</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function writeCometsLayout( input, filedir, filename, includeParams, writeModels, modelFileDir) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment">WRITECOMETSLAYOUT(input,[filedir],[filename],[includeParams],[writeModels],[modelFileDir]) Create a layout file along with the corresponding model
files
 Arguments:
     input: a CometsLayout struct
     filedir: directory in which files should be created. Defaults to the current working directory
     includeParams: should a 'parameters' block be included in the start of the file text?
     writeModels: should model files be created for each model in the given CometsLayout?
     modelFileDir: Directory that contains the model files. This string
     will be prepended onto the model file name, but not affect the
     destination where this script creates the model files (which is
     set in the filedir argument). This is intended for when the model
     files are already in a separate location, or an absolute path must be
     provided because the layout will be executed by a script that is not
     in the same location as it.</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="../../CometsToolbox/external/m2html/@template/char.html" class="code" title="function s = char(tpl)">char</a>	TEMPLATE Convert a template object in a one line description string</li><li><a href="writeCometsModel.html" class="code" title="function f = writeCometsModel( input, filename, cometsParams)">writeCometsModel</a>	WRITECOMETSMODEL create a Comets input file for the given model</li><li><a href="../../CometsToolbox/util/getModelName.html" class="code" title="function res = getModelName( model )">getModelName</a>	GETMODELNAME Parse the given COBRA model to return a name to be used in</li><li><a href="../../CometsToolbox/util/stridx.html" class="code" title="function [idx] = stridx(query, list, allowSubstr)">stridx</a>	STRIDX(str, {str}, [true]) Get the indexes of the query string in the given cell array.</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="createCometsFiles.html" class="code" title="function [ output_args ] = createCometsFiles(layout, directory, layoutFileName, separateParamsFiles, modelFileDir)">createCometsFiles</a>	CREATECOMETSFILES(layout, [directory], [layoutFileName], [separateParamsFiles])</li><li><a href="../../CometsToolbox/sample/old/demo62.html" class="code" title="">demo62</a>	Import from SBML</li><li><a href="../../CometsToolbox/test/testSetInitialPop.html" class="code" title="">testSetInitialPop</a>	TESTSETINITIALPOP Confirm that the setInitialPop function works as</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function mname = getModelFileName(model)</a></li><li><a href="#_sub2" class="code">function mname = getModelFilePath(model)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function writeCometsLayout( input, filedir, filename, includeParams, writeModels, modelFileDir)</a>
0002 <span class="comment">%WRITECOMETSLAYOUT(input,[filedir],[filename],[includeParams],[writeModels],[modelFileDir]) Create a layout file along with the corresponding model</span>
0003 <span class="comment">%files</span>
0004 <span class="comment">% Arguments:</span>
0005 <span class="comment">%     input: a CometsLayout struct</span>
0006 <span class="comment">%     filedir: directory in which files should be created. Defaults to the current working directory</span>
0007 <span class="comment">%     includeParams: should a 'parameters' block be included in the start of the file text?</span>
0008 <span class="comment">%     writeModels: should model files be created for each model in the given CometsLayout?</span>
0009 <span class="comment">%     modelFileDir: Directory that contains the model files. This string</span>
0010 <span class="comment">%     will be prepended onto the model file name, but not affect the</span>
0011 <span class="comment">%     destination where this script creates the model files (which is</span>
0012 <span class="comment">%     set in the filedir argument). This is intended for when the model</span>
0013 <span class="comment">%     files are already in a separate location, or an absolute path must be</span>
0014 <span class="comment">%     provided because the layout will be executed by a script that is not</span>
0015 <span class="comment">%     in the same location as it.</span>
0016 <span class="keyword">if</span> nargin == 2
0017     filename = <span class="string">'layout.txt'</span>;
0018     <span class="comment">%filedir = 'layout';</span>
0019 <span class="keyword">end</span>
0020 
0021 <span class="keyword">if</span> nargin &lt; 4
0022     includeParams = true; <span class="comment">%should the params block be printed within this file?</span>
0023 <span class="keyword">end</span>
0024 <span class="keyword">if</span> nargin &lt; 5
0025     writeModels = true;
0026 <span class="keyword">end</span>
0027 <span class="keyword">if</span> nargin &lt; 6
0028     modelFileDir = <span class="string">''</span>;
0029 <span class="keyword">end</span>
0030 
0031 <span class="keyword">if</span> isa(input,<span class="string">'string'</span>)
0032     strct=load(input);
0033     layout=strct.(<a href="../../CometsToolbox/external/m2html/@template/char.html" class="code" title="function s = char(tpl)">char</a>(fieldnames(strct)));
0034 <span class="keyword">else</span>
0035     <span class="keyword">if</span> isa(input,<span class="string">'CometsLayout'</span>)
0036         layout=input;
0037     <span class="keyword">else</span>
0038         error([<span class="string">'Invalid argument in writeCometslayout('</span> class(input)<span class="keyword">...</span>
0039             <span class="string">', '</span> class(filename) <span class="string">'): The first argument should '</span><span class="keyword">...</span>
0040             <span class="string">'be a well-structured COMETS layout or the path of a '</span><span class="keyword">...</span>
0041             <span class="string">'.mat file containing one.'</span>]);
0042     <span class="keyword">end</span>
0043 <span class="keyword">end</span>
0044 
0045 <span class="comment">% %deprecated- CometsLayout is now a class in order to enforce this %assert</span>
0046 <span class="comment">% that the input is a well-structured COMETS layout %check for these fields</span>
0047 <span class="comment">% for cf=['models' 'xdim' 'ydim' 'mets' 'media_amt' 'params'</span>
0048 <span class="comment">% 'diffusion_const' 'media_refresh']</span>
0049 <span class="comment">%     if ~isfield(layout,cf)</span>
0050 <span class="comment">%         error(['Invalid argument in writeCometsLayout(' class(input)...</span>
0051 <span class="comment">%             ', ' class(filename) '): The input layout requires the '...</span>
0052 <span class="comment">%             'following fields: [models xdim ydim mets media_amt params</span>
0053 <span class="comment">%             diffusion_const media_refresh]. Identified fields are '</span>
0054 <span class="comment">%             (char(fieldnames(model)))]);</span>
0055 <span class="comment">%     end</span>
0056 <span class="comment">% end</span>
0057 
0058 <span class="comment">%enforce that layout.models and layout.mets are cell arrays, not single</span>
0059 <span class="comment">%objects in order to simplify parsing downstream</span>
0060 <span class="keyword">if</span> isstruct(layout.models)
0061     layout.models = {layout.models};
0062 <span class="keyword">end</span>
0063 <span class="keyword">if</span> ischar(layout.mets)
0064     layout.mets = {layout.mets};
0065 <span class="keyword">end</span>
0066 <span class="keyword">if</span> ~iscell(layout.models)
0067     error([<span class="string">'Error in layout format: models should be of type cell array'</span><span class="keyword">...</span>
0068         <span class="string">'or be a single COBRA model struct.'</span>]);
0069 <span class="keyword">end</span>
0070 <span class="keyword">if</span> ~iscell(layout.mets)
0071     error([<span class="string">'Error in layout format: mets should be of type cell array'</span><span class="keyword">...</span>
0072         <span class="string">'or char.'</span>]);
0073 <span class="keyword">end</span>
0074 
0075 <span class="comment">%sort the metabolites in the layout alphabetically. Some sections of the</span>
0076 <span class="comment">%layout file may refer to media by their position in the sorted list, not</span>
0077 <span class="comment">%their position in the world_media section</span>
0078 layout = sortMetabolites(layout);
0079 
0080 
0081 filename = fullfile(filedir,filename);
0082 fileID=fopen(filename,<span class="string">'w'</span>);
0083 
0084 <span class="comment">% Parameters</span>
0085 <span class="comment">%</span>
0086 <span class="comment">% This block contains parameters initially loaded with the file. A list of</span>
0087 <span class="comment">% these with their accepted values is here. Here’s the structure of the</span>
0088 <span class="comment">% block:</span>
0089 <span class="comment">%</span>
0090 <span class="comment">% parameters</span>
0091 <span class="comment">%   param_1 = value_1</span>
0092 <span class="comment">%   param_2 = value_2</span>
0093 <span class="comment">%   . . .</span>
0094 <span class="comment">%   param_N = value_N</span>
0095 <span class="comment">% //</span>
0096 <span class="comment">%</span>
0097 <span class="comment">% This block is included at the top of the file for now because</span>
0098 <span class="comment">% flowDiffRate and growthDiffRate will only be applied if parameters are</span>
0099 <span class="comment">% loaded before model files.</span>
0100 <span class="keyword">if</span> includeParams
0101     fprintf(fileID,<span class="string">'\tparameters\n'</span>);
0102     
0103     pfields = fieldnames(layout.params);
0104     dontPrint = {<span class="string">'defaultReactionLower'</span>,<span class="string">'defaultReactionUpper'</span>,<span class="string">'defaultDiffConst'</span>,<span class="string">'objectiveStyle'</span>};
0105     logicalFields = {<span class="string">'writeBiomassLog'</span>,<span class="string">'writeFluxLog'</span>,<span class="string">'writeMediaLog'</span>,<span class="string">'writeTotalBiomassLog'</span>,<span class="keyword">...</span>
0106         <span class="string">'useLogNameTimeStamp'</span>,<span class="string">'showCycleTime'</span>,<span class="string">'showCycleCount'</span>,<span class="string">'saveslideshow'</span>,<span class="keyword">...</span>
0107         <span class="string">'slideshowColorRelative'</span>,<span class="string">'simulateActivation'</span>,<span class="string">'randomOrder'</span>,<span class="string">'pauseOnStep'</span>,<span class="string">'allowCellOverlap'</span>,<span class="keyword">...</span>
0108         <span class="string">'toroidalWorld'</span>,<span class="string">'colorRelative'</span>,<span class="string">'slideshowColorRelative'</span>};
0109     integerFields = {<span class="string">'maxCycles'</span>,<span class="string">'numDiffPerStep'</span>,<span class="string">'numRunThreads'</span>,<span class="string">'numExRxnSubsteps'</span>,<span class="string">'fluxLogRate'</span>,<span class="string">'mediaLogRate'</span>,<span class="string">'biomassLogRate'</span>,<span class="string">'totalBiomassLogRate'</span>};
0110     <span class="keyword">for</span> i = 1:length(pfields)
0111         p = pfields{i};
0112         <span class="keyword">if</span> ~ismember(p,dontPrint)
0113             c = <a href="../../CometsToolbox/external/m2html/@template/char.html" class="code" title="function s = char(tpl)">char</a>(p);
0114             val = getfield(layout.params,c);
0115             <span class="keyword">if</span> islogical(val) | ismember(c,logicalFields)
0116                 <span class="keyword">if</span> val
0117                     val = <span class="string">'true'</span>;
0118                 <span class="keyword">else</span>
0119                     val = <span class="string">'false'</span>;
0120                 <span class="keyword">end</span>
0121             <span class="keyword">end</span>
0122             <span class="keyword">if</span> ismember(c,integerFields)
0123                 val = round(val);
0124             <span class="keyword">end</span>
0125             <span class="comment">%     if ~ischar(val)</span>
0126             <span class="comment">%         val = char(val);</span>
0127             <span class="comment">%     end</span>
0128             fprintf(fileID,<span class="string">'\t%s = %s\n'</span>,<a href="../../CometsToolbox/external/m2html/@template/char.html" class="code" title="function s = char(tpl)">char</a>(p),num2str(val));
0129         <span class="keyword">end</span>
0130     <span class="keyword">end</span>
0131     fprintf(fileID,<span class="string">'//\n'</span>);
0132 <span class="keyword">end</span>
0133 
0134 
0135 <span class="comment">% The data blocks in this file are mostly nested within each other. The</span>
0136 <span class="comment">% model file block encapsulates the model world and initial population</span>
0137 <span class="comment">% blocks. The rest of the blocks are listed in the model world block.</span>
0138 
0139 
0140 <span class="comment">% 1. Model Names This is a single line block, NOT followed by // on a line</span>
0141 <span class="comment">% below, but at the end of the file. This must be the first line of the</span>
0142 <span class="comment">% layout file. It is followed by the name of at least one FBA model file.</span>
0143 <span class="comment">%</span>
0144 <span class="comment">% model_file model_file_name1 model_file_name2 ... model_file_name_N 2.</span>
0145 fprintf(fileID,<span class="string">'model_file'</span>);
0146 <span class="keyword">for</span> i = 1:length(layout.models)
0147     m = layout.models{i};
0148     mname = [modelFileDir <a href="#_sub1" class="code" title="subfunction mname = getModelFileName(model)">getModelFileName</a>(m)];
0149     fprintf(fileID,<span class="string">' %s'</span>,mname);
0150 <span class="keyword">end</span>
0151 fprintf(fileID,<span class="string">'\n'</span>);
0152 
0153 <span class="comment">% Model World</span>
0154 <span class="comment">%</span>
0155 <span class="comment">% This is a single line block, NOT followed by // on a line below, but</span>
0156 <span class="comment">% after several internal data blocks. This must be the first block inside</span>
0157 <span class="comment">% the model names block. It simply opens up the data block containing the</span>
0158 <span class="comment">% world information. Optionally, it can be followed by the name of a file</span>
0159 <span class="comment">% containing global media information (note that this is deprecated! Global</span>
0160 <span class="comment">% media information should be included in the layout file under the world</span>
0161 <span class="comment">% media block).</span>
0162 fprintf(fileID,<span class="string">'\tmodel_world\n'</span>);
0163 
0164 <span class="comment">% 2a. Grid Size</span>
0165 <span class="comment">%</span>
0166 <span class="comment">% This is required to be the first block under the model world line. It</span>
0167 <span class="comment">% doesn’t have a closing //, and only describes the width and height of the</span>
0168 <span class="comment">% simulation grid.</span>
0169 <span class="comment">%</span>
0170 <span class="comment">% grid_size  width  height</span>
0171 fprintf(fileID,<span class="string">'\t\tgrid_size %d %d\n'</span>,layout.xdim, layout.ydim);
0172 
0173 <span class="comment">% 2b. World Media</span>
0174 <span class="comment">%</span>
0175 <span class="comment">% The world media block contains global information of the quantity of all</span>
0176 <span class="comment">% extracellular metabolites in the simulation. Each row in the block has</span>
0177 <span class="comment">% two elements – the name of an extracellular metabolite (must be exactly</span>
0178 <span class="comment">% as found in the model file) followed by the quantity of that metabolite</span>
0179 <span class="comment">% initialized in every block in the simulation.</span>
0180 <span class="comment">%</span>
0181 <span class="comment">% This block must come before the media refresh, static media, and</span>
0182 <span class="comment">% diffusion constants blocks.</span>
0183 <span class="comment">%</span>
0184 <span class="comment">% world_media</span>
0185 <span class="comment">%   metab_1  quantity_1 metab_2  quantity_2 metab_3  quantity_3 . . .</span>
0186 <span class="comment">%   metab_N  quantity_N</span>
0187 <span class="comment">% //</span>
0188 fprintf(fileID,<span class="string">'\t\tworld_media\n'</span>);
0189 <span class="keyword">for</span> i = 1:length(layout.mets)
0190     m = layout.mets{i};
0191     idx = layout.metIdx(m);
0192     m = strrep(m,<span class="string">' '</span>,<span class="string">'_'</span>);
0193     fprintf(fileID,<span class="string">'\t\t%s %g\n'</span>,<a href="../../CometsToolbox/external/m2html/@template/char.html" class="code" title="function s = char(tpl)">char</a>(m),layout.media_amt(idx));
0194 <span class="keyword">end</span>
0195 fprintf(fileID,<span class="string">'\t//\n'</span>);
0196 <span class="comment">% 2c. Diffusion Constants</span>
0197 <span class="comment">%</span>
0198 <span class="comment">% The diffusion constants block contains diffusion constant information for</span>
0199 <span class="comment">% the extracellular metabolites in the simulation. The block begins with a</span>
0200 <span class="comment">% global default value on the same line as the opening tag. Each row in the</span>
0201 <span class="comment">% block, then, has two elements – the index of the metabolite in question,</span>
0202 <span class="comment">% in the same order as in the world_media block above (starting from 0);</span>
0203 <span class="comment">% and a value for the diffusion constant if it differs from the default.</span>
0204 <span class="comment">%</span>
0205 <span class="comment">% diffusion_constants    default_value</span>
0206 <span class="comment">%   index_1  diff_const_1 index_2  diff_const_2 index_3  diff_const_3 . . .</span>
0207 ddiff = layout.params.defaultDiffConst;
0208 fprintf(fileID,<span class="string">'\tdiffusion_constants %d\n'</span>,ddiff);
0209 <span class="keyword">if</span> any(layout.diffusion_constants(:,1))
0210     <span class="keyword">for</span> i = 1:length(layout.mets)
0211         m = layout.mets{i};
0212         idx = layout.metIdx(m);
0213         <span class="keyword">if</span> idx &amp;&amp; layout.diffusion_constants(idx,1) <span class="comment">%if the diffusion constant is set</span>
0214             dc = layout.diffusion_constants(idx,2);
0215             <span class="keyword">if</span> dc ~= ddiff <span class="comment">%and the diffusion constant is not equal to the default</span>
0216                 fprintf(fileID,<span class="string">'\t\t%d %g\n'</span>,idx-1,dc);
0217             <span class="keyword">end</span>
0218         <span class="keyword">end</span>
0219     <span class="keyword">end</span>
0220 <span class="keyword">end</span>
0221 fprintf(fileID,<span class="string">'\t//\n'</span>);
0222 
0223 <span class="comment">% // Media</span>
0224 <span class="comment">% This section should handle specification of media on a cell-by-cell</span>
0225 <span class="comment">% basis.</span>
0226 fprintf(fileID,<span class="string">'\tmedia\n'</span>);
0227 
0228 ms = size(layout.initial_media);
0229 <span class="comment">%s = [# metabolites in media, x, y]</span>
0230 
0231 <span class="keyword">if</span> length(ms) &lt; 3 <span class="comment">%don't break the loop if static_media is empty or 1x1</span>
0232     ms(3) = 1;
0233 <span class="keyword">end</span>
0234 
0235 <span class="keyword">for</span> x = 1:ms(2) <span class="comment">%for each x coordinate</span>
0236     <span class="keyword">for</span> y = 1:ms(3) <span class="comment">%and each y coordinate</span>
0237         v = layout.initial_media(:,x,y,1);<span class="comment">%is it set?</span>
0238         <span class="keyword">if</span> length(v) &lt; length(layout.mets)<span class="comment">%must include a value for all media</span>
0239             v(length(layout.mets)) = 0;
0240         <span class="keyword">end</span>
0241         <span class="keyword">if</span> any(v)
0242             fprintf(fileID,<span class="string">'\t\t%d %d'</span>,x-1,y-1);
0243             <span class="keyword">for</span> j = 1:length(v)
0244                 <span class="keyword">if</span> v(j) <span class="comment">%this medium is set</span>
0245                     fprintf(fileID,<span class="string">' %d'</span>, layout.initial_media(j,x,y,2));
0246                 <span class="keyword">else</span> <span class="comment">%use the global value</span>
0247                     fprintf(fileID,<span class="string">' %d'</span>, layout.media_amt(j));
0248                 <span class="keyword">end</span>
0249             <span class="keyword">end</span>
0250             fprintf(fileID,<span class="string">'\n'</span>);
0251         <span class="keyword">end</span>
0252     <span class="keyword">end</span>
0253 <span class="keyword">end</span>
0254 fprintf(fileID,<span class="string">'\t//\n'</span>);
0255 
0256 <span class="comment">% // 2d. Media Refresh</span>
0257 <span class="comment">%</span>
0258 <span class="comment">% This block describes how much each medium component should be refreshed</span>
0259 <span class="comment">% on each simulation cycle in any given grid space. The opening line</span>
0260 <span class="comment">% contains global refresh values for each medium component, in the same</span>
0261 <span class="comment">% order as presented in the world media block.</span>
0262 <span class="comment">%</span>
0263 <span class="comment">% Each proceeding row contains the amount of media to refresh for each grid</span>
0264 <span class="comment">% space where there is a nonzero refresh value. That is, the only rows that</span>
0265 <span class="comment">% should be present in this block should contain some amount of medium to</span>
0266 <span class="comment">% be refreshed.</span>
0267 <span class="comment">%</span>
0268 <span class="comment">% media_refresh  global_amt_1  global_amt_2  ...  global_amt_N</span>
0269 <span class="comment">%   row_1  col_1  amt_1  amt_2  amt_3  ...  amt_N row_2  col_2  amt_1 amt_2</span>
0270 <span class="comment">%   amt_3  ...  amt_N row_3  col_3  amt_1  amt_2  amt_3  ...  amt_N . . .</span>
0271 <span class="comment">%   row_M  col_M  amt_1  amt_2  amt_3  ...  amt_N</span>
0272 fprintf(fileID,<span class="string">'\tmedia_refresh'</span>);
0273 fprintf(fileID,<span class="string">' %d'</span>,layout.global_media_refresh);
0274 fprintf(fileID,<span class="string">'\n'</span>);
0275 
0276 [mdim,xdim,ydim] = size(layout.media_refresh);
0277 <span class="keyword">for</span> x = 1:xdim
0278     <span class="keyword">for</span> y = 1:ydim
0279         row = layout.media_refresh(1:mdim,x,y);
0280         <span class="keyword">if</span> any(row)
0281             <span class="comment">%fprintf(fileID,'\t\t%d %d %g\n',x-1,y-1,row);</span>
0282             fprintf(fileID,<span class="string">'\t\t%d %d '</span>,x-1,y-1);
0283             <span class="keyword">for</span> i = 1:length(row)
0284                 fprintf(fileID,<span class="string">'%d '</span>,row(i));
0285             <span class="keyword">end</span>
0286             fprintf(fileID,<span class="string">'\n'</span>);
0287         <span class="keyword">end</span>
0288     <span class="keyword">end</span>
0289 <span class="keyword">end</span>
0290 fprintf(fileID,<span class="string">'\t//\n'</span>);
0291 
0292 <span class="comment">% // 2e. Static Media</span>
0293 <span class="comment">%</span>
0294 <span class="comment">% Like the media refresh block, this describes how the media in each space</span>
0295 <span class="comment">% in the grid should be altered during the simulation. However, this block</span>
0296 <span class="comment">% describes which media components should remain at a static value. That</span>
0297 <span class="comment">% is, those media whose quantities should not change due to the effects of</span>
0298 <span class="comment">% the simulation. This might represent a constant sink or source of a</span>
0299 <span class="comment">% number of metabolites.</span>
0300 <span class="comment">%</span>
0301 <span class="comment">% This block contains pairs of data elements. Each pair starts with a</span>
0302 <span class="comment">% binary (0 or 1) element, denoting whether or not to use that pair as a</span>
0303 <span class="comment">% static element, and a quantity to keep that element static at. This lets</span>
0304 <span class="comment">% one build a static media set where only a few medium elements are</span>
0305 <span class="comment">% maintained as static, while keeping the file structure similar to the</span>
0306 <span class="comment">% media refresh block above.</span>
0307 <span class="comment">%</span>
0308 <span class="comment">% For example:</span>
0309 <span class="comment">%</span>
0310 <span class="comment">% static_media  0  0  1  0  1  2  0  0 // Breaks into 4 pairs [0 0], [1 0],</span>
0311 <span class="comment">% [1 2], [0 0]. Only components 2 and 3 have a 1 as their first element, so</span>
0312 <span class="comment">% those medium components are kept static. Component 2 remains at 0, while</span>
0313 <span class="comment">% component 3 stays at 2. Note that in this example, there are no</span>
0314 <span class="comment">% exceptions, so this applies throughout the simulation. In general, it is</span>
0315 <span class="comment">% done like this:</span>
0316 <span class="comment">%</span>
0317 <span class="comment">% static_media  use_1  amt_1  use_2  amt_2  use_3  amt_3  ...  use_N  amt_N</span>
0318 <span class="comment">%   row_1  col_1  use_1  amt_1  use_2  amt_2  ...  use_N  amt_N row_2 col_2</span>
0319 <span class="comment">%   use_1  amt_1  use_2  amt_2  ...  use_N  amt_N row_3  col_3 use_1  amt_1</span>
0320 <span class="comment">%   use_2  amt_2  ...  use_N  amt_N . . . row_M  col_M  use_1 amt_1  use_2</span>
0321 <span class="comment">%   amt_2  ...  use_N  amt_N</span>
0322 fprintf(fileID,<span class="string">'\tstatic_media'</span>);
0323 gs = size(layout.global_static_media);
0324 <span class="keyword">for</span> row = 1:gs(1)
0325     fprintf(fileID,<span class="string">' %g'</span>,layout.global_static_media(row,:));
0326 <span class="keyword">end</span>
0327 fprintf(fileID,<span class="string">'\n'</span>);
0328 
0329 s = size(layout.static_media);
0330 
0331 <span class="keyword">if</span> length(s) &lt; 3 <span class="comment">%don't break the loop if static_media is empty or 1x1</span>
0332     s(3) = 1;
0333 <span class="keyword">end</span>
0334 
0335 <span class="keyword">if</span> any(find(layout.static_media(:,:,:,1)))
0336     <span class="keyword">for</span> x = 1:s(2)
0337         <span class="keyword">for</span> y = 1:s(3)
0338             b = layout.static_media(:,x,y,1);<span class="comment">%is this medium static?</span>
0339             v = layout.static_media(:,x,y,2);<span class="comment">%values</span>
0340             i = find(b); <span class="comment">%indexes</span>
0341             <span class="keyword">if</span> any(i)
0342                 <span class="comment">%            b = zeros(1,gs(1));</span>
0343                 <span class="comment">%            b(i) = 1; %is this medium static?</span>
0344                 sm = [b';v'];
0345                 row = sm(1:(2*gs(1)));<span class="comment">%pairs of logical/value for each media</span>
0346                 fprintf(fileID,<span class="string">'\t\t%d %d'</span>,x-1,y-1);
0347                 <span class="keyword">for</span> j = 1:length(row)
0348                     fprintf(fileID,<span class="string">' %d'</span>,row(j));
0349                 <span class="keyword">end</span>
0350                 fprintf(fileID,<span class="string">'\n'</span>);
0351             <span class="keyword">end</span>
0352         <span class="keyword">end</span>
0353     <span class="keyword">end</span>
0354 <span class="keyword">end</span>
0355 fprintf(fileID,<span class="string">'\t//\n'</span>);
0356 
0357 <span class="comment">%% // 2f. Barrier Coordinates</span>
0358 <span class="comment">%</span>
0359 <span class="comment">% Simple enough, this block describes those grid coordinates that contain</span>
0360 <span class="comment">% barriers (i.e., no media, biomass, or diffusion can occur here).</span>
0361 <span class="comment">%</span>
0362 <span class="comment">% barrier</span>
0363 <span class="comment">%   row_1  col_1 row_2  col_2 row_3  col_3 . . . row_N  col_N</span>
0364 fprintf(fileID,<span class="string">'\tbarrier\n'</span>);
0365 s = size(layout.barrier);
0366 <span class="keyword">for</span> x = 1:s(1)
0367     <span class="keyword">for</span> y = 1:s(2)
0368         <span class="keyword">if</span> layout.barrier(x,y)
0369             fprintf(fileID,<span class="string">'\t\t%d %d\n'</span>,x-1,y-1);
0370         <span class="keyword">end</span>
0371     <span class="keyword">end</span>
0372 <span class="keyword">end</span>
0373 fprintf(fileID,<span class="string">'\t//\n'</span>);
0374 
0375 
0376 <span class="comment">%% 2g Periodic media</span>
0377 <span class="comment">% This block describes what and where should be the periodic media.</span>
0378 <span class="comment">% There are two settings, global and detailed.</span>
0379 <span class="comment">% Global:</span>
0380 <span class="comment">% metIndex  functionName   amplitude period  phase offset</span>
0381 <span class="comment">%</span>
0382 <span class="comment">% Detailed:</span>
0383 <span class="comment">% metIndex functionName    rowIndex  colIndex amplitude period phase offset</span>
0384 
0385 <span class="keyword">if</span> ~isempty(layout.global_periodic_media)   
0386     <span class="comment">% Global mode</span>
0387     fprintf(fileID,<span class="string">'\tperiodic_media\tglobal\n'</span>);
0388     <span class="comment">% Iterate over array and print if amplitude is &gt; 0</span>
0389     <span class="keyword">for</span> i=1:length(layout.global_periodic_media)
0390         gpm_i = layout.global_periodic_media{i};
0391         fprintf(fileID,<span class="string">'\t\t%d'</span>, gpm_i.idx - 1);
0392         fprintf(fileID,<span class="string">'\t%s'</span>, gpm_i.funcname);
0393         fprintf(fileID,<span class="string">'\t%d'</span>, gpm_i.amplitude);
0394         fprintf(fileID,<span class="string">'\t%d'</span>, gpm_i.period);
0395         fprintf(fileID,<span class="string">'\t%d'</span>, gpm_i.phase);
0396         fprintf(fileID,<span class="string">'\t%d'</span>, gpm_i.offset);
0397         fprintf(fileID,<span class="string">'\n'</span>);
0398     <span class="keyword">end</span>
0399 <span class="keyword">elseif</span> ~isempty(layout.detailed_periodic_media)
0400     <span class="comment">% Detailed mode</span>
0401     fprintf(fileID,<span class="string">'\tperiodic_media\tdetailed\n'</span>);
0402     <span class="keyword">for</span> i=1:length(layout.detailed_periodic_media)
0403         dpm_i = layout.detailed_periodic_media{i};
0404         fprintf(fileID,<span class="string">'\t\t%d'</span>, dpm_i.idx - 1);
0405         fprintf(fileID,<span class="string">'\t%s'</span>, dpm_i.funcname);
0406         fprintf(fileID,<span class="string">'\t%d'</span>, dpm_i.x - 1);
0407         fprintf(fileID,<span class="string">'\t%d'</span>, dpm_i.y - 1);
0408         fprintf(fileID,<span class="string">'\t%d'</span>, dpm_i.amplitude);
0409         fprintf(fileID,<span class="string">'\t%d'</span>, dpm_i.period);
0410         fprintf(fileID,<span class="string">'\t%d'</span>, dpm_i.phase);
0411         fprintf(fileID,<span class="string">'\t%d'</span>, dpm_i.offset);
0412         fprintf(fileID,<span class="string">'\n'</span>);
0413     <span class="keyword">end</span>
0414     
0415 <span class="keyword">end</span>
0416 fprintf(fileID, &quot;\t//\n&quot;);
0417 fprintf(fileID,<span class="string">'//\n'</span>);
0418 <span class="comment">% // 3. Initial Biomass Population</span>
0419 <span class="comment">%</span>
0420 <span class="comment">% This final block describes the initial biomass population in the layout,</span>
0421 <span class="comment">% and has many options.</span>
0422 <span class="comment">%</span>
0423 <span class="comment">% In the default biomass layout style, there is just initial_pop left alone</span>
0424 <span class="comment">% as the header, followed by one row for each grid space containing</span>
0425 <span class="comment">% biomass. There must be one quantity for each metabolic model in the</span>
0426 <span class="comment">% system.</span>
0427 <span class="comment">%</span>
0428 <span class="comment">% initial_pop</span>
0429 <span class="comment">%   row_1  col_1  biomass_1  biomass_2  ...  biomass_N row_2  col_2</span>
0430 <span class="comment">%   biomass_1  biomass_2  ...  biomass_N row_3  col_3  biomass_1  biomass_2</span>
0431 <span class="comment">%   ...  biomass_N . . . row_M  col_M  biomass_1  biomass_2  ...  biomass_N</span>
0432 <span class="comment">% // The next set of options modify the initial_pop line itself, and</span>
0433 <span class="comment">% contain no rows in the block, though the // on the line below must be</span>
0434 <span class="comment">% present.</span>
0435 <span class="comment">% NOTE: all coordinates here are 0-indexed!</span>
0436 <span class="comment">%</span>
0437 <span class="comment">% initial_pop  random  N1  biomass_1  N2  biomass_2 ... // This will</span>
0438 <span class="comment">% randomly assign Ni spaces to have biomass_i amount of biomass from model</span>
0439 <span class="comment">% i. If biomass from different species is allowed to overlap, then that is</span>
0440 <span class="comment">% allowed to happen in this case, but if different species is not allowed</span>
0441 <span class="comment">% to overlap, then that rule is upheld.</span>
0442 <span class="comment">%</span>
0443 <span class="comment">% initial_pop  random_rect  X  Y  W  H  N1  biomass_1  N2  biomass_2 ... //</span>
0444 <span class="comment">% As above, but the randomly assigned biomass spots are confined to a</span>
0445 <span class="comment">% rectangle with its upper-left corner at grid space (X,Y), with W grid</span>
0446 <span class="comment">% spaces wide, and H spaces tall.</span>
0447 <span class="comment">%</span>
0448 <span class="comment">% initial_pop  filled  biomass_1  biomass_2 ... // This will completely</span>
0449 <span class="comment">% fill the grid with the given amount of biomass from each species.</span>
0450 <span class="comment">%</span>
0451 <span class="comment">% initial_pop  filled_rect  X  Y  W  H  biomass_1  biomass_2 ... // This</span>
0452 <span class="comment">% will completely fill the rectangle (see above) with biomass from each</span>
0453 <span class="comment">% species.</span>
0454 <span class="comment">%</span>
0455 <span class="comment">% initial_pop  square  N1  biomass_1  N2  biomass_2 ... // This will fill</span>
0456 <span class="comment">% squares with radius Ni at the center of the grid with biomass_i from</span>
0457 <span class="comment">% species i.</span>
0458 <span class="keyword">if</span> sum(sum(any(layout.initial_pop))) &gt; 0 <span class="comment">%some initial pop is set</span>
0459     fprintf(fileID,<span class="string">'initial_pop\n'</span>);
0460     s = size(layout.initial_pop);
0461     <span class="keyword">if</span> length(s) &lt; 3 <span class="comment">%don't break the loop if initial_pop is empty or 1x1</span>
0462         s(3) = 1;
0463     <span class="keyword">end</span>
0464     <span class="keyword">for</span> x = 1:s(2)
0465         <span class="keyword">for</span> y = 1:s(3)
0466             v = layout.initial_pop(:,x,y);
0467             <span class="keyword">if</span> any(v)
0468                 <span class="comment">%x y pop1 pop2 pop3...</span>
0469                 fprintf(fileID,[<span class="string">'\t%d %d'</span> sprintf(<span class="string">' %d'</span>,v) <span class="string">'\n'</span>],x-1,y-1);
0470             <span class="keyword">end</span>
0471         <span class="keyword">end</span>
0472     <span class="keyword">end</span>
0473     fprintf(fileID,<span class="string">'//\n'</span>);
0474 <span class="keyword">else</span> <span class="comment">%no initial pop is set</span>
0475 <span class="comment">%     fprintf(fileID,'initial_pop filled');</span>
0476 <span class="comment">%     for i=1:length(layout.models)</span>
0477 <span class="comment">%         fprintf(fileID,' 1E-7');</span>
0478 <span class="comment">%     end</span>
0479     fprintf(fileID,<span class="string">'initial_pop'</span>);
0480     fprintf(fileID,<span class="string">'\n'</span>);
0481     fprintf(fileID,<span class="string">'//\n'</span>);
0482 <span class="keyword">end</span>
0483 
0484 <span class="comment">%if external reactions are set, print the relevent block</span>
0485 <span class="keyword">if</span> ~isempty(layout.external_rxn_mets)
0486     fprintf(fileID,<span class="string">'reactions\n'</span>);
0487     fprintf(fileID,<span class="string">'\treactants\n'</span>);
0488     mets = layout.external_rxn_mets;
0489     rxns = layout.external_rxns;
0490     metdims = size(mets);
0491     nrows = metdims(1);
0492     reactionnames = rxns.name;
0493     <span class="keyword">for</span> i = 1:nrows
0494         row = mets(i,:);
0495         <span class="keyword">if</span> row.stoich &lt; 0 <span class="comment">%only write reactants here</span>
0496             metidx = <a href="../../CometsToolbox/util/stridx.html" class="code" title="function [idx] = stridx(query, list, allowSubstr)">stridx</a>(row.met{1},layout.mets,false);
0497             rxnidx = <a href="../../CometsToolbox/util/stridx.html" class="code" title="function [idx] = stridx(query, list, allowSubstr)">stridx</a>(row.rxn{1},reactionnames,false);
0498             rxnrow = rxns(rxnidx,:);
0499             <span class="keyword">if</span> isempty(rxnrow.enzyme{1}) <span class="comment">%no enzyme</span>
0500                 sto = -row.stoich;
0501                 k = rxnrow.k;
0502                 fprintf(fileID,<span class="string">'\t\t%d %d %d %d\n'</span>, rxnidx, metidx, sto, k);
0503             <span class="keyword">else</span> <span class="comment">%enzyme catalyzed</span>
0504                 km = rxnrow.km;
0505                 fprintf(fileID,<span class="string">'\t\t%d %d %d\n'</span>, rxnidx, metidx, km);
0506             <span class="keyword">end</span>
0507         <span class="keyword">end</span>
0508     <span class="keyword">end</span>
0509     fprintf(fileID,<span class="string">'\tenzymes\n'</span>);
0510     rxndims = size(rxns);
0511     nrows = rxndims(1);
0512     <span class="keyword">for</span> i = 1:nrows
0513         row = rxns(i,:);
0514         <span class="keyword">if</span> ~isempty(row.enzyme{1})
0515             enzidx = <a href="../../CometsToolbox/util/stridx.html" class="code" title="function [idx] = stridx(query, list, allowSubstr)">stridx</a>(row.enzyme{1},layout.mets,false);
0516             fprintf(fileID,<span class="string">'\t\t%d %d %d\n'</span>, i, enzidx, row.k);
0517         <span class="keyword">end</span>
0518     <span class="keyword">end</span>
0519     fprintf(fileID,<span class="string">'\tproducts\n'</span>);
0520     nrows = metdims(1);
0521     <span class="keyword">for</span> i = 1:nrows
0522         row = mets(i,:);
0523         rxnidx = <a href="../../CometsToolbox/util/stridx.html" class="code" title="function [idx] = stridx(query, list, allowSubstr)">stridx</a>(row.rxn{1},reactionnames,false);
0524         <span class="keyword">if</span> row.stoich &gt; 0
0525             metidx = <a href="../../CometsToolbox/util/stridx.html" class="code" title="function [idx] = stridx(query, list, allowSubstr)">stridx</a>(row.met{1},layout.mets,false);
0526             sto = row.stoich;
0527             fprintf(fileID,<span class="string">'\t\t%d %d %d\n'</span>, rxnidx, metidx, sto);
0528         <span class="keyword">end</span>
0529     <span class="keyword">end</span>
0530     fprintf(fileID,<span class="string">'//\n'</span>);
0531 <span class="keyword">end</span>
0532 
0533 fclose(fileID);
0534 
0535 <span class="comment">%write the model files</span>
0536 <span class="keyword">if</span> writeModels
0537     <span class="keyword">for</span> i = 1:length(layout.models)
0538         m = layout.models{i};
0539         <a href="writeCometsModel.html" class="code" title="function f = writeCometsModel( input, filename, cometsParams)">writeCometsModel</a>(m,<a href="#_sub2" class="code" title="subfunction mname = getModelFilePath(model)">getModelFilePath</a>(m),layout.params);
0540     <span class="keyword">end</span>
0541 <span class="keyword">end</span>
0542 
0543     <a name="_sub1" href="#_subfunctions" class="code">function mname = getModelFileName(model)</a>
0544         name = <a href="../../CometsToolbox/util/getModelName.html" class="code" title="function res = getModelName( model )">getModelName</a>(model);
0545         mname = [name <span class="string">'.txt'</span>]; <span class="comment">%relative path; file goes in current directory</span>
0546     <span class="keyword">end</span>
0547     <a name="_sub2" href="#_subfunctions" class="code">function mname = getModelFilePath(model)</a>
0548         fname = <a href="#_sub1" class="code" title="subfunction mname = getModelFileName(model)">getModelFileName</a>(model);
0549         mname = fullfile(filedir,fname); <span class="comment">%absolute path</span>
0550     <span class="keyword">end</span>
0551 
0552 <span class="keyword">end</span>
0553</pre></div>
<hr><address>Generated on Mon 27-Jan-2020 12:49:43 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005</address>
</body>
</html>